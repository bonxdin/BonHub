<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Play MIDI with Nylon Guitar</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.35/Tone.min.js"></script>
</head>
<body>
  <h1>Hai ru̱ng quang</h1>
  <!-- <input type="file" id="midiInput" accept=".mid,.midi"><br><br>-->
  <button id="playBtn">▶️</button>
  <button id="pauseBtn">⏸️</button>
  <button id="stopBtn">⏹️</button>

  <script type="module">
    import { Midi } from "https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/+esm";

    //const midiInput = document.getElementById('midiInput');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');

    let midiData = null;
    let parts = [];
    let samplerLoaded = false;

    // Nylon guitar sample map (can be extended with more notes)
    const nylonGuitar = new Tone.Sampler({
      urls: {
        "E3": "E3.mp3",
        "G3": "G3.mp3",
        "C4": "C4.mp3",
        "E4": "E4.mp3",
        "G4": "G4.mp3",
        "C5": "C5.mp3",
        "E5": "E5.mp3",
        "G5": "G5.mp3",
        "C6": "C6.mp3",
        "E6": "E6.mp3",
        "G6": "G6.mp3",
      },
      baseUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/acoustic_guitar_nylon-mp3/",
      onload: () => {
        samplerLoaded = true;
        console.log("Nylon guitar samples loaded.");
		loadAndParseMIDI(); // Load the MIDI file after samples are ready
      }
    }).toDestination();
/*
    midiInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      midiData = new Midi(arrayBuffer);

      parts.forEach(p => p.dispose());
      parts = [];

      Tone.Transport.cancel();
      Tone.Transport.seconds = 0;

      midiData.tracks.forEach(track => {
        const part = new Tone.Part((time, note) => {
          nylonGuitar.triggerAttackRelease(note.name, note.duration, time, note.velocity);
        }, track.notes).start(0);
        parts.push(part);
      });
    });
*/
	async function loadAndParseMIDI() {
      const response = await fetch("sofa.mid");
      const arrayBuffer = await response.arrayBuffer();
      midiData = new Midi(arrayBuffer);

      parts.forEach(p => p.dispose());
      parts = [];

      Tone.Transport.cancel();
      Tone.Transport.seconds = 0;

      midiData.tracks.forEach(track => {
        const part = new Tone.Part((time, note) => {
          nylonGuitar.triggerAttackRelease(note.name, note.duration, time, note.velocity);
		  console.log(note.name);
        }, track.notes).start(0);
        parts.push(part);
      });

      console.log("MIDI file 'sofa.mid' loaded.");
    }
	
    playBtn.addEventListener('click', async () => {
      if (!midiData) {
        alert("Please select a MIDI file first.");
        return;
      }
      if (!samplerLoaded) {
        alert("Guitar samples are still loading. Please wait a moment.");
        return;
      }

      await Tone.start();
      if (Tone.Transport.state !== 'started') {
        Tone.Transport.start();
      } else {
        Tone.Transport.resume();
      }
    });

    pauseBtn.addEventListener('click', () => {
      if (Tone.Transport.state === 'started') {
        Tone.Transport.pause();
      }
    });

    stopBtn.addEventListener('click', () => {
      Tone.Transport.stop();
      Tone.Transport.seconds = 0;
    });
  </script>
</body>
</html>
